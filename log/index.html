<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <link
            rel="stylesheet"
            href="./model/prism.css"
    />
    <link rel="stylesheet" href="./model/prism-line-numbers.css" data-noprefix/>
    <style>
        .log-display {
            width: 100%;
            min-height: 30px; /* 根据需要设置最小高度 */
            overflow: auto; /* 如果内容超出，显示滚动条 */
            margin: 10px 0;
            font-family: monospace;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: white;
            position: relative;
            box-sizing: border-box;
        }

        .log-display pre {
            display: block; /* 确保 pre 是块级元素 */
            margin: 0; /* 移除默认外边距 */
            /*padding: 10px; !* 添加内边距 *!*/
            /*white-space: pre-wrap; !* 允许代码换行 *!*/
            /*word-wrap: break-word; !* 长单词也能换行 *!*/
            border: none; /* 移除 pre 默认的边框 */
            border-radius: 0; /* 移除 pre 默认的圆角，与外层容器保持一致 */
            box-sizing: border-box;
        }

        .log-display code {
            display: block;
            padding: 0;
            height: auto; /* 根据内容自动调整高度 */
            /*white-space: pre-wrap; !* 允许代码换行 *!*/
            box-sizing: border-box;
        }

        .highlight {
            background-color: yellow;
            /* 高亮区域样式 */
        }
    </style>
</head>

<body>

<div class="log-display" id="logDisplay">
    <pre contenteditable="true"><code id="baseCode" class="language-java line-numbers"><br></code></pre>
</div>

<script src="./model/prism.js"></script>
<script src="./model/prism-java.js"></script>
<script src="./model/prism-normalize-whitespace.js"></script>
<script src="./model/prism-line-numbers.js"></script>
<script>
    let logDisplay = document.getElementById("logDisplay");
    let pre = logDisplay.querySelector("pre");
    let code = document.getElementById("baseCode");

    utools.onPluginEnter(({utoolsCode, type, payload, option}) => {
        if (type === 'over') {
            code.textContent = payload
        }
        Prism.highlightAll()
    })

    // 监听 paste 事件，以便在粘贴后立即重新高亮
    pre.addEventListener("paste", function (event) {
        // event.preventDefault();
        // code.textContent = (event.clipboardData || window.clipboardData).getData('text/plain');
        // console.log(code.textContent)
        setTimeout(function() {
            // 获取页面上所有的 <code> 元素
            let codes = document.querySelectorAll('code');

            // 创建一个新的 <code> 元素，用于存储合并后的内容
            let baseCode = document.getElementById('baseCode');

            // 遍历所有的 <code> 元素，并将它们的文本内容累加
            let combinedText = '';
            for (let i = 0; i < codes.length; i++) {
                // 清理代码文本，只保留 '\n' 作为换行符
                let cleanedText = codes[i].innerText.replace(/\r?\n/g, '\n');
                combinedText += cleanedText + '\n'; // 添加换行符以分隔不同 <code> 的内容
            }

            // 去除最后一个多余的换行符
            combinedText = combinedText.trim();

            // 将合并后的文本设置为目标 <code> 元素的内容
            baseCode.textContent = combinedText;

            // 将目标 <code> 元素添加到页面的某个位置，例如一个特定的 pre 元素中
            let preElement = document.querySelector('pre'); // 假设你已经有一个 pre 元素
            preElement.textContent = ''; // 清空 pre 元素中的现有内容
            preElement.appendChild(baseCode);
            Prism.highlightAll()
        }, 0); // 延迟时间为 0，会在当前执行栈清空后执行
        //     Prism.highlightAll()
    });

    // 监听失去焦点事件，以便在内容变化后重新高亮
    pre.addEventListener("blur", function () {
        // 获取页面上所有的 <code> 元素
        let codes = document.querySelectorAll('code');

        // 创建一个新的 <code> 元素，用于存储合并后的内容
        let baseCode = document.getElementById('baseCode');

        // 遍历所有的 <code> 元素，并将它们的文本内容累加
        let combinedText = '';
        for (let i = 0; i < codes.length; i++) {
            // 清理代码文本，只保留 '\n' 作为换行符
            let cleanedText = codes[i].innerText.replace(/\r?\n/g, '\n');
            combinedText += cleanedText + '\n'; // 添加换行符以分隔不同 <code> 的内容
        }

        // 去除最后一个多余的换行符
        combinedText = combinedText.trim();

        // 将合并后的文本设置为目标 <code> 元素的内容
        baseCode.textContent = combinedText;

        // 将目标 <code> 元素添加到页面的某个位置，例如一个特定的 pre 元素中
        let preElement = document.querySelector('pre'); // 假设你已经有一个 pre 元素
        preElement.textContent = ''; // 清空 pre 元素中的现有内容
        preElement.appendChild(baseCode);
        Prism.highlightAll()
    });

    // 当内容被清空时，阻止进一步的删除操作
    pre.addEventListener('keydown', function (event) {
        if (event.key === 'Backspace' || event.key === 'Delete') {
            if (code.textContent.trim() === '') {
                event.preventDefault();
            }
        }
    });
</script>
</body>
</html>
